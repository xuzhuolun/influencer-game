# /research 命令

在创建规格前，调研现有模式并收集上下文信息。

---

## 角色定义

调研并记录发现，不对代码库做任何修改。

**你的职责：**
- 在代码库中搜索模式和规范
- 分析现有实现
- 调研外部解决方案的优缺点
- 展示选项，不做最终决策

**输出文件：** `./docs/specs/active/[task-id]/research.md`

---

## 使用方法

```
/research [task-id] [调研主题]
```

**示例：**
```
/research user-auth JWT vs 基于 session 的认证模式
/research payment-system 现有代码库中的 Stripe 集成模式
/research caching Redis vs 内存缓存的适用场景
```

---

## 执行流程

### 阶段 1：分析（只读）

**步骤 1：解析调研请求**
- 提取 task-id：`{{input}}`
- 提取调研主题
- 识别需要回答的关键问题

**步骤 2：明确调研范围**

如果以下任何一项不清晰，请提问：
- 应该关注内部模式还是外部解决方案？
- 有需要考虑或避免的特定技术吗？
- 有什么约束（性能、成本、团队熟悉度）？
- 主要目标是：理解现有代码还是探索新方案？

**提问格式：**
```
在开始调研前，一个快速问题：

我应该关注：
A) 内部模式 - 我们的代码库如何处理类似问题？
B) 外部解决方案 - 有哪些库/方案可用？
C) 两者都要 - 内部和外部选项的完整分析

（默认：C - 两者都要）
```

**步骤 3：规划调研策略**

识别：
- 要搜索的目录
- 要查找的模式
- 要参考的外部资源
- 时间分配（内部 vs 外部）

### 阶段 2：规划（展示计划）

**开始前展示调研计划：**

```
## 调研计划

**Task ID:** [task-id]
**主题:** [调研主题]

**调研问题：**
1. [关键问题 1]
2. [关键问题 2]
3. [关键问题 3]

**内部调研（代码库）：**
- 搜索目录: [列表]
- 要查找的模式: [列表]
- 要研究的类似功能: [列表]

**外部调研：**
- 要评估的技术: [列表]
- 要记录的最佳实践: [列表]

**输出：**
- 文件: `./docs/specs/active/[task-id]/research.md`
- 结构: 执行摘要 → 代码库分析 → 外部选项 → 建议

**预计时间:** 60 分钟

准备好开始了吗？
```

**等待用户确认后再继续。**

### 阶段 3：执行（确认后）

**步骤 1：创建目录结构**
```
./docs/specs/active/[task-id]/
└── research.md
```

**步骤 2：进行内部调研**

在代码库中搜索：
- 类似功能实现
- 使用的模式和规范
- 可复用的工具和组件
- 架构决策

**对于每个发现，记录：**
```markdown
### [模式/功能名称]

**位置:** `path/to/file.ts`

**工作原理:**
[简要说明]

**代码示例:**
```[语言]
[相关代码片段]
```

**可复用性:** [这如何应用到我们的任务]
```

**步骤 3：进行外部调研**

对于每个选项/技术：
```markdown
### [选项名称]

**是什么:** [简要描述]

**优点:**
- [优点 1]
- [优点 2]

**缺点:**
- [缺点 1]
- [缺点 2]

**适合我们的场景:** [高/中/低] - [原因]
```

**步骤 4：生成 research.md**

使用以下结构：

```markdown
# 调研: [主题]

**Task ID:** [task-id]
**日期:** [date]
**状态:** 完成

---

## 执行摘要

[2-3 段关键发现和初步建议的摘要]

---

## 代码库分析

### 现有模式

[记录代码库中发现的模式，附代码示例]

### 可复用组件

[列出可复用的组件/工具]

### 应遵循的规范

[要保持的编码规范和架构模式]

---

## 外部解决方案

### 选项 1: [名称]

**概述:** [描述]

**优点:**
- [优点 1]
- [优点 2]

**缺点:**
- [缺点 1]
- [缺点 2]

**实现复杂度:** [低/中/高]
**团队熟悉度:** [低/中/高]

### 选项 2: [名称]

[相同结构]

### 选项 3: [名称]

[相同结构]

---

## 对比矩阵

| 标准 | 选项 1 | 选项 2 | 选项 3 |
|------|--------|--------|--------|
| 性能 | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ |
| 复杂度 | ⭐⭐ | ⭐⭐⭐ | ⭐ |
| 团队适配 | ⭐⭐⭐ | ⭐ | ⭐⭐ |
| 维护性 | ⭐⭐ | ⭐⭐⭐ | ⭐⭐ |

---

## 建议

### 首选方案

[推荐的方案及理由]

### 备选方案

[如果首选方案不可行的备选]

---

## 待解决问题

- [规格阶段需要回答的问题]
- [需要相关方输入的决策]

---

## 下一步

1. 与团队评审发现
2. 继续运行 `/specify` 定义需求
3. 在规划前解决待解决问题

---

*使用 SDD 2.0 完成调研*
```

### 阶段 4：验证

**检查点：调研完成（必需）**

最终输出前验证：
- [ ] 文件创建在 `./docs/specs/active/[task-id]/research.md`
- [ ] 代码库模式已附示例记录
- [ ] 多个选项已展示优缺点
- [ ] 已包含对比矩阵
- [ ] 已提供带理由的建议
- [ ] 已列出待解决问题

**回读文件验证其存在。**

---

## 输出格式（必需）

**你的回复必须以此结尾：**

```
✅ 调研完成: `./docs/specs/active/[task-id]/research.md`

**关键发现：**
- [发现 1]
- [发现 2]
- [发现 3]

**建议:** [首选方案]

**发现的代码库模式:** [数量] 个可复用模式
**评估的选项:** [数量] 个方案已对比

**下一步：**
- 评审调研文档
- 如需要与团队讨论建议
- 运行 `/specify [task-id]` 定义需求
- 或运行 `/plan [task-id]` 如果需求已明确

**待解决问题:** [数量] 项需要在继续前输入
```

---

## 常见问题

### 问题：未找到现有模式
**原因**：新项目或全新功能
**解决方案**：关注外部调研和最佳实践：
- "未找到现有模式 - 这将建立新的规范"
- 改为记录行业最佳实践

### 问题：选项太多无法评估
**原因**：调研主题太宽泛
**解决方案**：缩小范围：
- "这里有很多方案。让我基于 [标准] 关注前 3 个"

### 问题：代码库中存在冲突模式
**原因**：技术债务或随时间演进
**解决方案**：记录两者并给出建议：
- "我发现了两种不同的模式。模式 A（较新，在 X 个文件中）和模式 B（较旧，在 Y 个文件中）。建议遵循模式 A。"

---

## 相关命令

- `/specify [task-id]` - 基于调研定义需求
- `/plan [task-id]` - 创建技术方案（如果需求明确）
- `/brief [task-id]` - 快速规划（跳过深度调研）
- `/sdd-full-plan [project-id]` - 完整项目路线图
