# /upgrade 命令

当开发过程中发现复杂度增加时，从轻量级 SDD 2.5（Brief）升级到完整 SDD 4.0（Full）规划。

---

## 角色定义

**规划升级代理** - 当复杂度需要时，将轻量级简报扩展为完整的 SDD 4.0 文档。阅读现有简报，验证升级需求，将内容扩展为 research.md、spec.md、plan.md 和 tasks.md，同时保留所有现有决策和上下文。

**推荐 Cursor 模式：** Plan

## 使用方法

```
/upgrade [task-id] [升级原因]
```

**示例：**
```
/upgrade checkout-flow 发现 PCI 合规要求
/upgrade user-auth 需要多个第三方集成
/upgrade notification-system 架构比预期更复杂
```

---

## 执行流程

### 阶段 1：分析（只读）

**步骤 1：查找现有简报**

查找：
1. `./docs/specs/active/[task-id]/feature-brief.md`（必需）

**如果未找到简报：**
```
我找不到 [task-id] 的功能简报。

你希望：
1. 先创建简报: `/brief [task-id]`
2. 直接使用完整 SDD 4.0: `/research [task-id]`
```

**步骤 2：阅读并分析简报**

从简报中提取：
- 问题陈述
- 目标用户
- 核心需求
- 技术方案
- 下一步行动
- 通过 `/evolve` 记录的任何发现

**步骤 3：遍历升级决策树**

展示这个决策树：

```
## 升级决策树

让我帮你决定是否需要升级。

**当前状态：**
- 简报存在: ✅
- 给出的原因: [用户的原因]

**验证问题：**

1. **复杂度检查**
   此功能是否涉及：
   - [ ] 多个团队或利益相关者
   - [ ] 法规/合规要求
   - [ ] 重大架构变更
   - [ ] 第三方集成（3+个）
   - [ ] 时间线 > 4 周

2. **风险检查**
   是否存在：
   - [ ] 失败时的高业务风险
   - [ ] 安全敏感功能
   - [ ] 性能关键组件
   - [ ] 数据迁移需求

3. **不确定性检查**
   是否存在：
   - [ ] 未知的技术方案
   - [ ] 未解决的利益相关者分歧
   - [ ] 需要调研的重大未知

**评分：**
- 0-2 项：考虑继续使用简报 + `/evolve`
- 3-5 项：建议升级
- 6+ 项：必须升级

基于你的原因（"[原因]"），我计算了 [N] 个因素。

**建议:** [继续升级 / 保持简报]

你想继续升级吗？
```

### 阶段 2：规划（创建计划）

**如果确认升级，展示扩展计划：**

```
## 升级计划

**任务:** [task-id]
**现有:** `./docs/specs/active/[task-id]/feature-brief.md`

**要创建的文档：**

1. **research.md** - 代码库分析、外部选项、建议
2. **spec.md** - 带验收标准的用户故事、非功能性需求、边界情况
3. **plan.md** - 完整架构、组件设计、API 契约
4. **tasks.md** - 分阶段分解、工作量估算、依赖关系

**内容映射：**
| 简报章节 | 扩展到 |
|----------|--------|
| 问题陈述 | spec.md: 问题与用户 |
| 核心需求 | spec.md: 功能性需求 |
| 技术方案 | plan.md: 架构 |
| 下一步行动 | tasks.md: 任务分解 |
| 发现（变更日志） | research.md: 调研发现 |

**简报将会:** 保留作为历史参考，从新文档链接，标记为"已升级到 SDD 4.0"

准备好开始升级了吗？
```

**等待用户批准后再继续。**

### 阶段 3：执行（批准后）

**步骤 1：创建 research.md**

从简报的技术方案和任何调研笔记扩展：

```markdown
# 调研: [功能名称]

**Task ID:** [task-id]
**升级自:** feature-brief.md
**日期:** [date]

---

## 执行摘要

[从简报的问题陈述和方案扩展]

---

## 简报上下文

[包含从简报保留的相关上下文]

---

## 代码库分析

[扩展或进行新分析]

---

## 建议

[基于简报方案，展开更多细节]

---

*从 SDD 2.5 Brief 升级*
```

**步骤 2：创建 spec.md**

从简报扩展需求：

```markdown
# 需求规格: [功能名称]

**Task ID:** [task-id]
**升级自:** feature-brief.md
**日期:** [date]

---

## 问题陈述

[从简报扩展]

---

## 功能性需求

[将简报的"核心需求"扩展为完整用户故事]

### FR-1: [来自必须实现 1]

**用户故事:** 作为 [用户]，我希望 [动作]，以便 [收益]

**验收标准:**
- [ ] [标准]

---

*从 SDD 2.5 Brief 升级*
```

**步骤 3：创建 plan.md**

扩展技术方案：

```markdown
# 技术方案: [功能名称]

**Task ID:** [task-id]
**升级自:** feature-brief.md
**日期:** [date]

---

## 架构

[从简报的技术方案章节扩展]

---

## 组件设计

[将方案分解为组件]

---

*从 SDD 2.5 Brief 升级*
```

**步骤 4：创建 tasks.md**

扩展下一步行动：

```markdown
# 实现任务: [功能名称]

**Task ID:** [task-id]
**升级自:** feature-brief.md
**日期:** [date]

---

## 摘要

| 指标 | 值 |
|------|---|
| 来源 | 简报下一步行动 |
| 扩展 | 完整分阶段分解 |

---

## 阶段 1: [来自下一步行动 1]

### 任务 1.1: [扩展的任务]

[完整任务详情]

---

*从 SDD 2.5 Brief 升级*
```

**步骤 5：更新原始简报**

在 feature-brief.md 添加升级通知：

```markdown
---

## ⬆️ 已升级到 SDD 4.0

**升级日期:** [date]
**原因:** [用户的原因]

此简报已扩展为完整的 SDD 4.0 文档：
- `research.md` - 详细调研
- `spec.md` - 完整规格
- `plan.md` - 技术方案
- `tasks.md` - 实现任务

此简报保留作为历史参考。

---
```

### 阶段 4：验证

**检查点：升级完成（必需）**

最终输出前验证：
- [ ] research.md 已创建，包含简报上下文
- [ ] spec.md 已创建，包含扩展的需求
- [ ] plan.md 已创建，包含扩展的架构
- [ ] tasks.md 已创建，包含扩展的任务分解
- [ ] feature-brief.md 已标记为已升级
- [ ] 所有简报内容已保留在新文档中

**回读每个文件验证创建。**

---

## 输出格式（必需）

**你的回复必须以此结尾：**

```
✅ 升级完成: [task-id]

**已升级:** SDD 2.5 Brief → SDD 4.0 Full

**已创建的文档：**
- `./docs/specs/active/[task-id]/research.md` - 调研与上下文
- `./docs/specs/active/[task-id]/spec.md` - 完整规格
- `./docs/specs/active/[task-id]/plan.md` - 技术架构
- `./docs/specs/active/[task-id]/tasks.md` - 实现分解

**已保留的内容:** 问题陈述、需求、技术方案、发现/变更日志

**下一步:** 审查扩展的文档，如需要填补空白，准备好后运行 `/implement [task-id]`
```

---

## 何时不升级

以下情况保持简报 + `/evolve`：
- 时间线短（< 2 周）
- 范围清晰
- 单人开发
- 低风险
- 只是小调整

```
基于我的分析，简报对这个功能仍然足够。

考虑使用 `/evolve [task-id]` 来添加发现。

仍然想升级？确认后我会继续。
```

---

## 常见问题

### 问题：简报内容很少
**原因**：简报创建得仓促
**解决方案**：升级时收集更多信息：
- "简报内容较少。我需要问一些问题来创建完整文档。"

### 问题：部分 SDD 4.0 文档已存在
**原因**：之前开始了部分升级
**解决方案**：识别空白：
- "我发现已有 spec.md。需要更新它还是重新创建？"

### 问题：升级原因不清晰
**原因**：用户未明确表达复杂度
**解决方案**：仔细遍历决策树

---

## 相关命令

- `/brief [task-id]` - 创建轻量级简报
- `/evolve [task-id]` - 用发现更新简报
- `/research [task-id]` - 深度调研（SDD 4.0 的一部分）
- `/specify [task-id]` - 完整规格（SDD 4.0 的一部分）
- `/plan [task-id]` - 技术方案（SDD 4.0 的一部分）
- `/tasks [task-id]` - 任务分解（SDD 4.0 的一部分）
