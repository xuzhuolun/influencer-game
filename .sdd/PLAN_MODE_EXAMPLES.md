# PLAN 模式示例

本文档演示了每个 SDD 命令的典型 PLAN 模式交互，展示了计划-批准-执行工作流程的实际操作。

## 概述

现在每个 SDD 命令都遵循以下模式：
```
用户命令 → 分析 → 创建计划 → 用户批准 → 执行 → 记录
```

这些示例展示了在启用 PLAN 模式时使用每个命令时可以预期的内容。

### Cursor 2.1 增强功能

**交互式问题 UI:**
- 问题现在出现在交互式界面中
- 直接在 UI 中回答以加快工作流程
- 如果信息已经清晰可跳过问题

**计划搜索 (⌘+F):**
- 使用 ⌘+F 在生成的计划中搜索
- 快速找到特定部分或关键词
- 高效导航大型计划

**AI 代码审查:**
- 实现后自动代码审查
- 问题出现在侧边面板中
- 直接在编辑器中修复 bug

---

## 示例 1: `/brief` - 功能简报创建

### 场景
为用户个人资料自定义创建快速功能简报。

### 用户命令
```
/brief user-profile-custom 允许用户使用头像和简介自定义个人资料
```

### AI 分析阶段
```
正在分析请求...
- 检查现有用户个人资料实现
- 识别需求差距
- 评估简报是否适合复杂度

给您的问题：
1. 头像应该支持文件上传还是从库中选择？
2. 简介文本是否有字符限制？
3. 是否应包含隐私设置？
```

### 用户回应
```
1. 仅文件上传（jpg、png）
2. 是的，500 字符限制
3. 不，隐私设置是单独的功能
```

### AI 计划展示
```
/brief user-profile-custom 的计划

**将创建的内容：**
- 文件：specs/active/user-profile-custom/feature-brief.md

**简报结构：**
1. 问题陈述
   - 用户希望个性化其个人资料
   - 目标：所有注册用户
   
2. 快速研究（15 分钟）
   - 检查现有用户个人资料代码
   - 检查文件上传模式
   - 审查验证模式
   
3. 核心需求
   - 头像上传（jpg/png，最大 5MB）
   - 简介文本字段（最多 500 字符）
   - 保存前预览
   - 验证和错误处理
   
4. 实现方法
   - 使用现有文件上传服务
   - 添加新的个人资料自定义组件
   - 与用户设置页面集成
   
5. 下一步操作
   - 设置文件上传端点
   - 创建个人资料编辑表单
   - 实现验证

**预计规划时间：** 30 分钟

批准此计划？
```

### 用户批准
```
已批准。继续。
```

### AI 执行
```
创建功能简报...
✓ 创建 specs/active/user-profile-custom/
✓ 研究现有模式（找到 FileUploadService）
✓ 生成 feature-brief.md
✓ 更新 specs/index.md

结果：功能简报已准备好开发！
```

---

## 示例 2: `/evolve` - 活文档更新

### 场景
根据实现过程中的发现更新现有简报。

### 用户命令
```
/evolve checkout-flow 发现我们需要处理不同格式的国际地址
```

### AI 分析阶段
```
正在分析变更请求...
- 读取当前 feature-brief.md
- 理解变更范围
- 评估对现有实现的影响

此变更影响：
- 需求部分（地址处理）
- 实现方法（验证逻辑）
- 下一步操作（添加国际化）

问题：我们应该支持所有国家还是从前 5 个市场开始？
```

### 用户回应
```
从美国、英国、加拿大、澳大利亚、德国开始
```

### AI 计划展示
```
/evolve checkout-flow 的计划

**将更新的内容：**
- 文件：specs/active/checkout-flow/feature-brief.md

**建议的更改：**

之前（需求部分）：
```
- 收集收货地址（单一格式）
- 验证地址字段
```

之后（需求部分）：
```
- 收集收货地址（多格式支持）
  - 美国：ZIP 代码，州下拉菜单
  - 英国：邮政编码，郡可选
  - 加拿大：邮政编码，省份下拉菜单
  - 澳大利亚：邮政编码，州下拉菜单
  - 德国：PLZ，联邦州下拉菜单
- 按国家格式验证地址字段
- 从 IP 自动检测国家或允许手动选择
```

**变更日志条目：**
```markdown
### 2024-01-15 - 国际地址支持
**变更：** 添加了多国家地址格式支持
**原因：** 在实现过程中发现需要国际运输
**影响：** 需要国家特定的验证和格式处理
**市场：** 美国、英国、加拿大、澳大利亚、德国（第 1 阶段）
```

**建议：** 如果这增长到 10+ 个国家，请考虑升级到完整 SDD

批准这些更改？
```

### 用户批准
```
看起来不错，但还要注意我们将来需要货币转换
```

### AI 执行
```
更新功能简报...
✓ 更新需求部分
✓ 更新实现方法添加 i18n 说明
✓ 添加变更日志条目
✓ 添加关于未来货币转换需求的说明

结果：功能简报已更新并与实现保持一致！
```

---

## 示例 3: `/research` - 模式调研

### 场景
在规格之前研究认证模式。

### 用户命令
```
/research auth-system JWT 认证与会话管理
```

### AI 分析阶段
```
正在分析研究范围...
- 检查现有认证代码
- 识别相关功能
- 确定研究深度

问题：
1. 研究应该专注于内部模式还是也包括外部库？
2. 是否有特定的安全要求（2FA、SSO 等）？
3. 研究时间表（快速 30 分钟还是深度 2 小时探索）？
```

### 用户回应
```
1. 内部和外部都要
2. 先基本认证，第 2 阶段再做 2FA
3. 深度探索 - 这是关键基础设施
```

### AI 计划展示
```
/research auth-system 的计划

**将创建的内容：**
- 文件：specs/active/auth-system/research.md

**研究策略：**

1. 内部代码库分析（60 分钟）
   - 搜索现有认证模式：`AuthService`、`TokenManager`
   - 检查会话处理：`SessionStore`、中间件
   - 审查安全实践：密码哈希、令牌存储
   - 要检查的文件：
     * src/services/auth/*.js
     * src/middleware/authentication.js
     * src/utils/crypto.js

2. 外部解决方案研究（45 分钟）
   - JWT 库：jsonwebtoken vs jose
   - 会话存储：Redis vs 内存 vs 数据库
   - 行业最佳实践：OWASP 指南
   - 类似实现：Auth0 模式、Firebase Auth

3. 安全分析（30 分钟）
   - 令牌过期策略
   - 刷新令牌模式
   - XSS/CSRF 保护
   - 速率限制方法

**研究文档结构：**
- 执行摘要
- 内部模式分析（包含代码示例）
- 外部解决方案比较
- 安全考虑
- 带优缺点的推荐方法
- 规格阶段的待解决问题

**预期发现：**
- 可利用的现有加密工具
- 令牌管理的模式建议
- 要遵循的安全最佳实践
- 规格阶段的决策点

批准研究计划？
```

### 用户批准
```
完美！继续。
```

### AI 执行
```
正在进行研究...
✓ 搜索代码库中的认证模式（找到 12 个相关文件）
✓ 分析现有 CryptoService
✓ 研究 JWT 库（记录了 3 个选项）
✓ 审查安全最佳实践
✓ 创建全面的 research.md

关键发现：
- 可以利用现有 CryptoService 进行密码哈希
- 推荐 jsonwebtoken（已在其他地方使用）
- 推荐 Redis 作为会话存储（已可用）
- 找到了优秀的中间件模式可遵循

结果：研究完成！准备进入 /specify 阶段。
```

---

## 示例 4: `/implement` - 系统化实现

### 场景
基于现有计划执行实现。

### 用户命令
```
/implement user-notifications
```

### AI 分析阶段
```
正在分析实现范围...
- 读取 plan.md、spec.md、tasks.md
- 识别要遵循的现有模式
- 检查可重用组件

发现：
- 带架构的全面计划
- tasks.md 中定义了 23 个任务
- 现有 NotificationService 可扩展
- WebSocket 设置已可用

问题：
1. 我们应该实现所有通知类型还是只从邮件开始？
2. 有任何特定任务需要优先处理吗？
```

### 用户回应
```
1. 先从邮件开始，然后是应用内通知
2. 先专注后端，前端可以等
```

### AI 计划展示
```
/implement user-notifications 的计划

**将创建的内容：**
1. 文件：specs/active/user-notifications/todo-list.md
2. 跨多个文件的代码实现
3. 在 progress.md 中跟踪进度

**实现策略：**

第 1 阶段：后端基础（优先）
- [ ] 扩展 NotificationService 支持邮件（3h）
- [ ] 创建通知模板系统（2h）
- [ ] 实现带重试逻辑的邮件队列（3h）
- [ ] 添加通知偏好设置模型（2h）
- [ ] 创建通知 API 端点（3h）

第 2 阶段：应用内通知
- [ ] 添加应用内通知模型（2h）
- [ ] 创建通知 WebSocket 处理器（3h）
- [ ] 实现通知持久化（2h）
- [ ] 添加已读/未读跟踪（2h）

第 3 阶段：前端（延后）
- [ ] 通知铃铛组件
- [ ] 通知列表 UI
- [ ] 偏好设置页面

第 4 阶段：测试和润色
- [ ] NotificationService 的单元测试
- [ ] API 端点的集成测试
- [ ] 邮件流程的 E2E 测试

**模式复用：**
- 将遵循现有 EmailService 模式
- 使用现有作业队列基础设施
- 利用报告功能的模板系统

**执行顺序：**
后端优先方法，专注于具有适当队列和可靠性的邮件通知。

**成功标准：**
- 所有第 1 阶段待办事项完成
- 邮件通知可靠发送
- API 端点已记录和测试
- 准备好前端集成

批准实现计划？
```

### 用户批准
```
很棒的计划！开始吧。
```

### AI 执行
```
创建待办列表并开始实现...

✓ 创建 todo-list.md 包含 15 个详细待办事项
✓ 创建 progress.md 用于跟踪

开始第 1 阶段实现...

[x] 扩展 NotificationService 支持邮件（3h）
    - 添加 sendEmail 方法
    - 与现有 EmailService 集成
    - 添加错误处理和重试逻辑
    
[x] 创建通知模板系统（2h）
    - 创建 templates/ 目录
    - 实现模板引擎集成
    - 添加 5 个默认模板
    
[x] 实现带重试逻辑的邮件队列（3h）
    - 使用现有 Bull 队列
    - 添加指数退避
    - 实现死信队列
    
... （继续系统地完成所有待办事项）

第 1 阶段完成！后端邮件通知功能正常。
进度：5/15 待办事项完成，接下来是第 2 阶段。
```

---

## 示例 5: `/upgrade` - 升级复杂度

### 场景
当发现复杂性时将简报转换为完整 SDD。

### 用户命令
```
/upgrade payment-integration 发现 PCI 合规要求和需要多个支付提供商
```

### AI 分析阶段
```
正在分析升级触发...
- 读取现有 feature-brief.md
- 理解合规要求
- 评估新的复杂度级别

当前简报涵盖：
- 基本支付处理
- 单一提供商（Stripe）
- 简单结账流程

新要求添加：
- PCI 合规考虑
- 多提供商支持（Stripe + PayPal + Apple Pay）
- 支付方式存储
- 退款/争议处理
- 合规文档

这种复杂性证明了完整 SDD 2.0 工作流程的必要性。

问题：
1. 需要什么合规级别？（SAQ A、SAQ A-EP 等）
2. 完整实现的时间表？
3. 团队规模（影响任务分解）？
```

### 用户回应
```
1. SAQ A-EP（我们会临时处理卡数据）
2. 8 周实现
3. 3 名开发者 + 1 名安全顾问
```

### AI 计划展示
```
/upgrade payment-integration 的计划

**将创建的内容：**
- 保留：feature-brief.md（重命名为 feature-brief-v1.md）
- 创建：research.md - 支付提供商比较和 PCI 要求
- 创建：spec.md - 带合规的全面需求
- 创建：plan.md - 带安全考虑的架构
- 创建：tasks.md - 详细的 8 周任务分解

**内容映射：**

从 feature-brief.md：
- 问题/用户 → spec.md 问题陈述（扩展）
- 需求 → spec.md 功能需求（详细带 FR-ID）
- 实现说明 → plan.md 架构（全面）
- 下一步操作 → tasks.md 第 1 阶段任务（详细）

要添加的新内容：

**research.md 将包含：**
- Stripe vs PayPal vs Apple Pay 比较
- PCI 合规要求分析
- 安全最佳实践研究
- 行业标准审查
- 带理由的建议

**spec.md 将包含：**
- 合规要求（PCI SAQ A-EP）
- 多提供商要求
- 安全要求（加密、令牌化）
- 带安全考虑的详细用户故事
- 边界情况（支付失败、退款、争议）
- 成功指标和 KPI

**plan.md 将包含：**
- 符合 PCI 的安全架构
- 支付提供商抽象层
- 令牌化策略
- 带安全控制的数据流
- 带认证的 API 设计
- 安全测试方法
- 合规文档计划

**tasks.md 将包含：**
- 8 周分阶段分解
- 安全审查任务
- 合规文档任务
- 多开发者任务分配
- 包括安全测试的测试
- 带安全加固的部署

**升级理由：**
- 合规要求需要全面规划
- 多提供商支持增加架构复杂性
- 安全影响需要详细分析
- 3 名开发者团队需要详细协调
- 8 周时间表需要结构化方法

批准升级计划？
```

### 用户批准
```
太棒了！这正是我们需要的。继续。
```

### AI 执行
```
升级到完整 SDD 2.0...

✓ 将 feature-brief.md 重命名为 feature-brief-v1.md
✓ 创建全面的 research.md
  - 比较了 3 个支付提供商
  - 分析了 PCI 合规要求
  - 记录了安全最佳实践
  
✓ 创建详细的 spec.md
  - 15 个功能需求（FR-001 到 FR-015）
  - 8 个非功能需求（安全、性能）
  - 12 个带验收标准的用户故事
  - 合规要求部分
  - 全面的边界情况
  
✓ 创建全面的 plan.md
  - 安全的多提供商架构
  - 令牌化和加密策略
  - 带安全控制的 API 设计
  - 带安全考虑的数据库架构
  - 包括渗透测试的测试策略
  
✓ 创建详细的 tasks.md
  - 8 周分解（4 个阶段）
  - 45 个带估算的详细任务
  - 任务依赖关系已映射
  - 建议的团队分配
  - 安全审查检查点

结果：完整 SDD 2.0 套件已创建！
准备好进行安全、合规的支付集成开发。
```

---

## 关键要点

### PLAN 模式展示的优势

1. **可见性**：在发生之前看到将要创建的内容
2. **控制**：在执行前批准或修改计划
3. **质量**：更深思熟虑、更全面的规划
4. **学习**：理解 AI 的推理和方法
5. **安全**：没有意外的文件更改

### 来自示例的技巧

- **命令要具体**：更多细节 = 更好的计划
- **回答澄清问题**：帮助 AI 创建更好的计划
- **仔细审查计划**：这是您纠正方向的机会
- **提供反馈**：计划根据您的输入而改进
- **信任流程**：计划-批准-执行确保质量

### 当计划需要调整时

如果计划不太对：
```
AI: "这是我的计划..."
您: "接近了，但请也包含 X 并将 Y 改为 Z"
AI: "已根据您的更改更新计划..."
```

AI 会修改并重新展示直到您满意为止。

---

## 下一步

想看更多示例？
- 在您自己的项目中尝试命令
- 从 `/brief` 开始快速功能
- 使用 `/research` 探索模式
- 用 `/evolve` 尝试更新

有问题？查看：
- [指南](.sdd/guidelines.md) - 方法论详情
- [命令文档](.cursor/commands/) - 各个命令参考
- [系统规则](.cursor/rules/sdd-system.mdc) - 理念和模式

