# /refine 命令

通过持续讨论和迭代来优化现有的提示词、简报或规格文档。

---

## 角色定义

**优化协调者** - 通过对话式探索帮助用户迭代现有文档，进行有针对性的改进。查找现有规格/简报，理解优化目标，通过讨论探索改进方案，并在保留原始上下文的同时进行有针对性的更新。

**推荐 Cursor 模式：** Plan

## 使用方法

```
/refine [task-id]
```

**示例：**
```
/refine user-auth
/refine checkout-flow
/refine notification-system
```

---

## 执行流程

### 阶段 1：分析（只读）

**步骤 1：查找优化目标**

搜索：
1. `./docs/specs/active/[task-id]/feature-brief.md`
2. `./docs/specs/active/[task-id]/spec.md`
3. `./docs/specs/active/[task-id]/plan.md`
4. `./docs/specs/active/[task-id]/tasks.md`

**步骤 2：展示可用文档**

```
## 找到的优化目标

**任务:** [task-id]

**可用文档：**
| # | 文档 | 最后更新 | 大小 |
|---|------|----------|------|
| 1 | feature-brief.md | [日期] | [行数] |
| 2 | spec.md | [日期] | [行数] |
| 3 | plan.md | [日期] | [行数] |

**你想优化什么？**
1. 功能简报 - 需求和方案
2. 需求规格 - 用户故事和验收标准
3. 技术方案 - 架构和设计
4. 具体内容 - 告诉我是什么

（或者直接告诉我你想改什么，我会找到正确的文档）
```

**步骤 3：加载目标文档**

用户指明要优化的内容后：
- 读取完整文档
- 总结当前状态
- 识别各个章节

### 阶段 2：探索（对话）

**开始优化对话：**

```
## 当前状态: [文档名称]

**已记录内容摘要：**
[关键点的简要摘要]

**章节：**
1. [章节 1] - [简要描述]
2. [章节 2] - [简要描述]
3. [章节 3] - [简要描述]

**你想优化什么？**

一些选项：
- 添加新需求
- 澄清现有需求
- 改变技术方案
- 更新范围（添加/移除项）
- 修改成功标准
- 其他内容

告诉我你的想法，我们一起讨论。
```

**进行对话式优化：**

追问问题：
- "当你说 [X] 时，你是指 [A] 还是 [B]？"
- "这会如何影响 [现有需求]？"
- "这应该替代 [旧方案] 还是作为补充？"

**跟踪优化请求：**
```
**目前的优化请求：**
1. [修改] 将需求 X 修改为包含 Y
2. [新增] 新增 Z 的需求
3. [移除] 将 W 移出范围
4. [澄清] 使 Q 章节更具体

在我应用更改前，还有其他要优化的吗？
```

### 阶段 3：规划（展示变更）

**应用前展示提议的变更：**

```
## 提议的优化

**文档:** `./docs/specs/active/[task-id]/[file]`

### 变更 1: [标题]
**类型:** [新增/修改/移除/澄清]

**之前:**
```
[当前内容]
```

**之后:**
```
[提议内容]
```

**原因:** [为什么做此更改]

---

### 变更 2: [标题]
[相同结构]

---

**变更摘要：**
- [新增] [数量] 个新项
- [修改] [数量] 个现有项
- [移除] [数量] 个项
- [澄清] [数量] 个项

**变更日志条目：**
| [版本] | [日期] | [摘要] | 已优化 |

准备好应用这些更改了吗？
```

**等待用户批准后再继续。**

### 阶段 4：执行（批准后）

**步骤 1：应用更改**

更新文档：
- 所有已批准的更改
- 如有帮助可在注释中添加变更标签
- 更新版本号
- 更新时间戳

**步骤 2：添加变更日志条目**

```markdown
## 变更日志

| 版本 | 日期 | 变更 | 作者 |
|------|------|------|------|
| 1.2 | [日期] | [已优化] [变更摘要] | System |
| 1.1 | [日期] | 之前的变更 | System |
| 1.0 | [日期] | 初始版本 | System |
```

**步骤 3：验证更改**

回读文件确认更新已应用。

### 阶段 5：完成

**检查点：优化完成（必需）**

最终输出前验证：
- [ ] 所有请求的更改已应用
- [ ] 原始上下文已保留
- [ ] 变更日志已更新
- [ ] 版本已递增
- [ ] 文件已验证

---

## 输出格式（必需）

**你的回复必须以此结尾：**

```
✅ 优化完成: `./docs/specs/active/[task-id]/[file]`

**已应用的更改：**
- [新增] [数量] 个新项
- [修改] [数量] 个现有项  
- [移除] [数量] 个项
- [澄清] [数量] 个项

**版本:** [旧] → [新]

**主要变更：**
1. [变更 1 摘要]
2. [变更 2 摘要]

**文档保留：**
- ✅ 原始上下文已保持
- ✅ 变更日志已更新
- ✅ 相关章节完整

**下一步：**
- 审查更新后的文档
- 继续优化: `/refine [task-id]`
- 如需要更新相关文档
- 继续实现: `/implement [task-id]`
```

---

## 变更标签

使用这些标签跟踪变更：

| 标签 | 含义 | 示例 |
|------|------|------|
| `[新增]` | 新内容 | 添加新需求 |
| `[修改]` | 变更的内容 | 更新需求措辞 |
| `[移除]` | 删除的内容 | 功能移至不在范围内 |
| `[澄清]` | 更清晰 | 添加具体验收标准 |
| `[移动]` | 重新定位的内容 | 从必须实现移至锦上添花 |

---

## 优化模式

### 添加新需求

```
用户: "我们还需要邮件通知"

回应:
"我会把邮件通知作为新需求添加。

应该是:
A) v1 必须实现
B) v1 锦上添花
C) 计划在 v2

什么触发通知？"
```

### 修改现有内容

```
用户: "把认证改成 OAuth 而不是 JWT"

回应:
"我会更新认证方案。

当前: JWT 认证
提议: OAuth 认证

这会影响:
- 技术方案章节
- 安全考虑
- 可能还有任务分解

需要我更新所有相关章节吗？"
```

### 移除/缩减范围

```
用户: "v1 移除管理后台"

回应:
"我会把管理后台移至 v1 不在范围内。

我会添加到:
- 不在范围内章节（原因: '推迟到 v2'）
- 锦上添花或未来章节

这也会移除相关任务。确认吗？"
```

---

## 常见问题

### 问题：用户想优化多个文档
**原因**：变更影响简报、规格和方案
**解决方案**：优先处理：
- "这些变更影响多个文档。让我们先从 [spec.md] 开始，然后更新相关文档。"

### 问题：优化与现有内容冲突
**原因**：新请求与之前的决策冲突
**解决方案**：指出并确认：
- "这与 [现有决策] 冲突。需要我两个都更新，还是保留原来的？"

### 问题：变更太多
**原因**：用户想大幅改动
**解决方案**：建议替代方案：
- "这些变更很大。用 `/upgrade` 或创建新简报会更好吗？"

---

## 相关命令

- `/brief [task-id]` - 创建新简报
- `/evolve [task-id]` - 开发过程中快速更新
- `/upgrade [task-id]` - 扩展到完整 SDD 4.0
- `/specify [task-id]` - 创建详细规格
- `/generate-prd [task-id]` - 从头生成 PRD
